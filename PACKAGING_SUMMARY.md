# Guillotine CLI - Homebrew Packaging Infrastructure

## Overview

This document provides a complete overview of the infrastructure-as-code setup for packaging and publishing the Guillotine CLI to Homebrew.

## What Was Created

### 1. GoReleaser Configuration
**File**: `apps/cli/.goreleaser.yml`

Multi-platform build configuration that:
- Cross-compiles for macOS (amd64, arm64), Linux (amd64, arm64), Windows (amd64, arm64)
- Creates release archives with checksums
- Automatically updates Homebrew formula
- Manages GitHub releases

**Key Features**:
- CGO-enabled builds for Zig FFI integration
- Proper library bundling (libguillotine.dylib/so)
- Platform-specific compiler configuration
- Automated changelog generation

### 2. GitHub Actions Workflow
**File**: `.github/workflows/release.yml`

Automated release pipeline that:
- Builds Zig library for all target platforms
- Cross-compiles Go CLI with proper toolchains
- Runs GoReleaser to create releases
- Updates Homebrew tap automatically
- Runs installation tests

**Trigger**: Push Git tags matching `v*.*.*` (e.g., `v1.0.0`)

### 3. Build System Integration
**File**: `apps/cli/build.zig`

Added Zig build commands:
- `zig build cli-release` - Optimized release build
- `zig build cli-goreleaser-test` - Test GoReleaser configuration locally

### 4. Developer Tools

#### Pre-Release Check Script
**File**: `apps/cli/scripts/pre-release-check.sh`

Validates readiness for release:
- Git status (clean working directory)
- Required tools installed (zig, go, goreleaser)
- Version requirements met
- Build succeeds (Zig + Go)
- Tests pass
- GoReleaser configuration valid
- Snapshot build succeeds

Usage: `./apps/cli/scripts/pre-release-check.sh`

#### Makefile
**File**: `apps/cli/Makefile`

Convenient commands:
- `make build` - Build CLI
- `make test` - Run tests
- `make release-check` - Pre-release validation
- `make release-local` - Test release locally
- `make release` - Interactive release creation
- `make ci` - Simulate CI pipeline

### 5. Documentation

#### Quick Start Guide
**File**: `apps/cli/QUICKSTART.md`

Get from zero to published in ~25 minutes:
1. Prerequisites (5 min)
2. Setup Homebrew tap (10 min)
3. Test locally (5 min)
4. Create release (2 min)
5. Verify (3 min)

#### Homebrew Tap Setup Guide
**File**: `apps/cli/HOMEBREW_TAP_SETUP.md`

Detailed instructions for:
- Creating the `homebrew-tap` repository
- Repository structure and conventions
- GitHub token configuration
- Formula testing and debugging
- Maintenance procedures

#### Release Process Documentation
**File**: `apps/cli/RELEASE.md`

Comprehensive release guide covering:
- Automated vs manual releases
- Version numbering (semver)
- Workflow details
- Rollback procedures
- Troubleshooting
- Best practices

## Architecture

### Release Flow

```
┌─────────────────┐
│  Developer      │
│  git tag v1.0.0 │
│  git push       │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  GitHub Actions                     │
│  (.github/workflows/release.yml)    │
│                                     │
│  1. Build Zig Library               │
│     - macOS (arm64, x86_64)         │
│     - Linux (arm64, x86_64)         │
│                                     │
│  2. Cross-Compile Go CLI            │
│     - Uses GoReleaser               │
│     - Links against Zig library     │
│     - Creates archives              │
│                                     │
│  3. Create GitHub Release           │
│     - Upload binaries               │
│     - Generate checksums            │
│                                     │
│  4. Update Homebrew Formula         │
│     - Push to evmts/homebrew-tap    │
│     - Update URLs and checksums     │
│                                     │
│  5. Test Installation               │
│     - brew install guillotine       │
│     - Run smoke tests               │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Users                              │
│  brew tap evmts/tap                 │
│  brew install guillotine            │
└─────────────────────────────────────┘
```

### Repository Structure

```
evmts/guillotine (main repository)
├── .github/workflows/
│   └── release.yml                    # Automated release pipeline
├── apps/cli/
│   ├── .goreleaser.yml                # Cross-platform build config
│   ├── build.zig                      # Zig build integration
│   ├── Makefile                       # Developer commands
│   ├── scripts/
│   │   └── pre-release-check.sh       # Pre-release validation
│   ├── QUICKSTART.md                  # Quick start guide
│   ├── HOMEBREW_TAP_SETUP.md          # Tap setup instructions
│   └── RELEASE.md                     # Release process guide
└── PACKAGING_SUMMARY.md               # This file

evmts/homebrew-tap (separate repository)
├── Formula/
│   └── guillotine.rb                  # Auto-generated by GoReleaser
└── README.md
```

## Key Design Decisions

### 1. Separate Tap Repository

Following Homebrew convention, the tap is a separate repository named `homebrew-tap`. This allows:
- Independent version control for formulae
- Automatic updates by GoReleaser
- Standard Homebrew tap conventions
- Clean separation of concerns

### 2. GoReleaser for Build Automation

GoReleaser handles:
- Cross-compilation for multiple platforms
- Archive creation and checksums
- GitHub release management
- Homebrew formula generation
- Consistent release artifacts

**Why GoReleaser?**
- Industry standard for Go projects
- Built-in Homebrew support
- Handles CGO cross-compilation
- Extensive platform support

### 3. GitHub Actions for CI/CD

Automated pipeline triggered by Git tags:
- Consistent build environment
- Multi-stage build (Zig → Go)
- Automatic testing
- Zero-touch releases

**Benefits**:
- No local environment dependencies
- Reproducible builds
- Automated quality checks
- Fast feedback loop

### 4. Infrastructure as Code

All configuration is version-controlled:
- GoReleaser config (YAML)
- GitHub Actions workflow (YAML)
- Build integration (Zig)
- Helper scripts (Bash)

**Benefits**:
- Auditable changes
- Easy rollback
- Team collaboration
- Documentation as code

## Prerequisites

### One-Time Setup

1. **Create Homebrew Tap Repository**
   - Repository: `evmts/homebrew-tap`
   - Public visibility
   - Initialize with README

2. **Configure GitHub Token**
   - Personal access token with `repo` + `write:packages` scopes
   - Add as `HOMEBREW_TAP_GITHUB_TOKEN` secret in main repository

3. **Install Tools** (for local testing)
   ```bash
   brew install goreleaser/tap/goreleaser
   go version  # >= 1.25
   zig version # 0.15.1
   ```

## Usage

### Creating a Release

#### Automated (Production)

```bash
# Tag and push
git tag -a v1.0.0 -m "Release v1.0.0"
git push origin v1.0.0

# GitHub Actions handles the rest
```

#### Manual (Testing)

```bash
cd apps/cli

# Validate
make release-check

# Test build
make release-local

# Verify artifacts
ls -lh dist/
```

### Installing

Users can install with:

```bash
brew tap evmts/tap
brew install guillotine
```

### Updating

```bash
brew update
brew upgrade guillotine
```

## Monitoring and Maintenance

### GitHub Actions

Monitor releases at: `https://github.com/evmts/guillotine/actions`

Typical workflow duration: 15-20 minutes

### Homebrew Formula

Track updates at: `https://github.com/evmts/homebrew-tap/commits/main`

Each release creates a new commit updating the formula.

### Release Artifacts

View at: `https://github.com/evmts/guillotine/releases`

Each release includes:
- Source code archives (auto-generated)
- Binary archives for each platform
- Checksums file
- Release notes

## Troubleshooting

### Common Issues

1. **Release Fails in GitHub Actions**
   - Check Actions logs for specific error
   - Most common: HOMEBREW_TAP_GITHUB_TOKEN missing or expired
   - Solution: Regenerate token and update secret

2. **GoReleaser Build Fails**
   - Usually: Missing cross-compilation toolchain
   - Solution: Workflow installs required toolchains
   - For local builds: Install gcc-aarch64-linux-gnu, mingw-w64

3. **Formula Installation Fails**
   - Check formula syntax: `brew audit --strict Formula/guillotine.rb`
   - Test locally: `brew install --build-from-source Formula/guillotine.rb`
   - Common: Library path issues or missing dependencies

4. **Token Permission Errors**
   - Token needs both `repo` and `write:packages` scopes
   - Token must be added as `HOMEBREW_TAP_GITHUB_TOKEN` secret
   - Verify at: `https://github.com/evmts/guillotine/settings/secrets/actions`

### Debug Commands

```bash
# Test GoReleaser locally
cd apps/cli
goreleaser check
goreleaser release --snapshot --clean

# Test Homebrew formula
brew audit --strict --online Formula/guillotine.rb
brew install --verbose --build-from-source Formula/guillotine.rb

# Test Zig build
zig build -Doptimize=ReleaseFast
zig build test

# Test Go build
cd apps/cli
go build -v .
```

## Versioning Strategy

Following [Semantic Versioning](https://semver.org/):

- **Major** (X.0.0): Breaking changes
- **Minor** (0.X.0): New features, backward compatible
- **Patch** (0.0.X): Bug fixes, backward compatible

Examples:
- `v0.1.0` - Initial release
- `v0.2.0` - Added new command
- `v0.2.1` - Fixed bug
- `v1.0.0` - Stable API, production ready

## Security Considerations

### Secrets Management

- `HOMEBREW_TAP_GITHUB_TOKEN`: Stored in GitHub Secrets
- Never commit tokens to repository
- Rotate tokens periodically
- Use minimum required permissions

### Supply Chain Security

- All dependencies pinned in go.mod/go.sum
- Submodules tracked at specific commits
- Checksums verified for downloads
- Reproducible builds via GoReleaser

## Future Enhancements

### Potential Improvements

1. **Additional Package Managers**
   - Scoop (Windows)
   - AUR (Arch Linux)
   - APT/RPM repositories

2. **Auto-Update Mechanism**
   - Self-update command in CLI
   - Version check on startup
   - Download and replace binary

3. **Signing and Notarization**
   - Code signing for binaries
   - macOS notarization
   - Windows authenticode signing

4. **Release Automation**
   - Automatic changelog generation
   - Semantic release based on commits
   - Pre-release branches (alpha, beta)

5. **Testing Improvements**
   - Integration tests in CI
   - Multi-platform testing matrix
   - Benchmark tracking

## References

### Documentation
- [Quick Start Guide](apps/cli/QUICKSTART.md)
- [Homebrew Tap Setup](apps/cli/HOMEBREW_TAP_SETUP.md)
- [Release Process](apps/cli/RELEASE.md)
- [CLI README](apps/cli/README.md)

### External Resources
- [GoReleaser Documentation](https://goreleaser.com/)
- [Homebrew Formula Cookbook](https://docs.brew.sh/Formula-Cookbook)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Semantic Versioning](https://semver.org/)

## Support

- **Issues**: https://github.com/evmts/guillotine/issues
- **Discussions**: https://github.com/evmts/guillotine/discussions
- **Main Repository**: https://github.com/evmts/guillotine
- **Homebrew Tap**: https://github.com/evmts/homebrew-tap

---

**Last Updated**: 2025-01-15
**Status**: ✅ Ready for production use