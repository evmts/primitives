# Homebrew Tap Setup Guide

This guide explains how to set up a Homebrew tap for publishing the Guillotine CLI.

## Overview

The Guillotine CLI uses GoReleaser to automatically create and update a Homebrew formula in a separate tap repository. This allows users to install the CLI with:

```bash
brew tap evmts/tap
brew install guillotine
```

## Repository Structure

You need to create a **separate** GitHub repository for the Homebrew tap:

**Repository Name**: `homebrew-tap`
**GitHub Organization**: `evmts`
**Full URL**: `https://github.com/evmts/homebrew-tap`

### Why a Separate Repository?

Homebrew convention requires tap repositories to be named `homebrew-<tap-name>`. The tap repository only contains Homebrew formulae and is automatically updated by GoReleaser during releases.

## Setup Instructions

### 1. Create the Tap Repository

```bash
# Create a new repository on GitHub
# Name: homebrew-tap
# Organization: evmts
# Public visibility
# Initialize with README

# Clone it locally
git clone https://github.com/evmts/homebrew-tap.git
cd homebrew-tap
```

### 2. Initialize Repository Structure

```bash
# Create Formula directory
mkdir -p Formula

# Create README
cat > README.md << 'EOF'
# Guillotine Homebrew Tap

Official Homebrew tap for [Guillotine](https://github.com/evmts/guillotine) - a high-performance EVM implementation.

## Installation

```bash
brew tap evmts/tap
brew install guillotine
```

## Usage

```bash
guil --help
```

## About

This tap is automatically updated by GoReleaser when new versions are released.

Formula source: [guillotine.rb](Formula/guillotine.rb)
EOF

# Create initial formula placeholder (will be overwritten by GoReleaser)
cat > Formula/guillotine.rb << 'EOF'
# This formula is automatically generated by GoReleaser
# Manual changes will be overwritten on the next release

class Guillotine < Formula
  desc "High-performance EVM implementation CLI tool"
  homepage "https://github.com/evmts/guillotine"
  version "0.0.0"

  on_macos do
    if Hardware::CPU.arm?
      url "https://github.com/evmts/guillotine/releases/download/v0.0.0/guillotine_0.0.0_darwin_arm64.tar.gz"
      sha256 "0000000000000000000000000000000000000000000000000000000000000000"
    else
      url "https://github.com/evmts/guillotine/releases/download/v0.0.0/guillotine_0.0.0_darwin_x86_64.tar.gz"
      sha256 "0000000000000000000000000000000000000000000000000000000000000000"
    end
  end

  on_linux do
    if Hardware::CPU.arm?
      url "https://github.com/evmts/guillotine/releases/download/v0.0.0/guillotine_0.0.0_linux_arm64.tar.gz"
      sha256 "0000000000000000000000000000000000000000000000000000000000000000"
    else
      url "https://github.com/evmts/guillotine/releases/download/v0.0.0/guillotine_0.0.0_linux_x86_64.tar.gz"
      sha256 "0000000000000000000000000000000000000000000000000000000000000000"
    end
  end

  def install
    bin.install "guil"
    lib.install Dir["zig-out/lib/libguillotine.*"]
  end

  test do
    system "#{bin}/guil", "--version"
  end
end
EOF

# Commit initial structure
git add .
git commit -m "Initial tap structure"
git push origin main
```

### 3. Configure GitHub Token

GoReleaser needs a GitHub token with write access to the tap repository:

1. **Create Personal Access Token**:
   - Go to GitHub Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic)
   - Click "Generate new token (classic)"
   - Name: "GoReleaser Homebrew Tap"
   - Scopes:
     - âœ… `repo` (Full control of private repositories)
     - âœ… `write:packages` (Write packages)
   - Generate token and copy it

2. **Add Secret to Main Repository**:
   - Go to `https://github.com/evmts/guillotine/settings/secrets/actions`
   - Click "New repository secret"
   - Name: `HOMEBREW_TAP_GITHUB_TOKEN`
   - Value: Paste the token from step 1
   - Click "Add secret"

### 4. Verify GoReleaser Configuration

The `.goreleaser.yml` file in `apps/cli/` should have:

```yaml
brews:
  - name: guillotine
    repository:
      owner: evmts
      name: homebrew-tap
      branch: main
      token: "{{ .Env.HOMEBREW_TAP_GITHUB_TOKEN }}"
    directory: Formula
    # ... rest of configuration
```

## Release Process

### Automated Release (Recommended)

1. **Tag a release** in the main repository:
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```

2. **GitHub Actions** will automatically:
   - Build the Zig library for all platforms
   - Cross-compile the Go CLI
   - Create release archives
   - Update the Homebrew formula
   - Push changes to `homebrew-tap`

### Manual Release (Testing)

```bash
cd apps/cli

# Dry-run to verify configuration
goreleaser release --snapshot --clean

# Actual release (requires Git tag)
git tag v1.0.0
goreleaser release --clean
```

## Testing the Formula

### Local Testing Before Release

```bash
# Install from local formula file
brew install --build-from-source Formula/guillotine.rb

# Test installation
guil --version
guil --help

# Uninstall
brew uninstall guillotine
```

### Testing After Release

```bash
# Add the tap
brew tap evmts/tap

# Install
brew install guillotine

# Verify
guil --version

# Update to latest
brew upgrade guillotine
```

## Troubleshooting

### Formula Audit Errors

Run Homebrew audit to check for issues:

```bash
brew audit --strict Formula/guillotine.rb
```

### Installation Failures

Check the formula logs:

```bash
brew install --verbose --debug guillotine
```

### Token Issues

Verify the token has correct permissions:
- Token must have `repo` and `write:packages` scopes
- Token must be added as `HOMEBREW_TAP_GITHUB_TOKEN` secret
- Token must be valid (not expired)

### Formula Not Updating

Force update the tap:

```bash
brew update
brew tap --repair
brew reinstall guillotine
```

## Repository Permissions

The `HOMEBREW_TAP_GITHUB_TOKEN` needs write access to:

1. **Main repository** (`evmts/guillotine`):
   - Create releases
   - Upload assets

2. **Tap repository** (`evmts/homebrew-tap`):
   - Push commits
   - Update formula files

## Maintenance

### Updating Formula Metadata

Edit `.goreleaser.yml` in the main repository:

```yaml
brews:
  - name: guillotine
    homepage: "https://github.com/evmts/guillotine"
    description: "High-performance EVM implementation CLI tool"
    license: "MIT"
    dependencies:
      - name: zig
        type: build
```

### Adding Test Commands

Enhance the test block in `.goreleaser.yml`:

```yaml
brews:
  - # ... other config
    test: |
      system "#{bin}/guil", "--version"
      system "#{bin}/guil", "--help"
```

## References

- [Homebrew Formula Cookbook](https://docs.brew.sh/Formula-Cookbook)
- [GoReleaser Homebrew Documentation](https://goreleaser.com/customization/homebrew/)
- [GitHub Actions Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)

## Next Steps

1. âœ… Create `homebrew-tap` repository
2. âœ… Initialize repository structure
3. âœ… Create GitHub token
4. âœ… Add token to repository secrets
5. âœ… Verify GoReleaser configuration
6. ðŸš€ Create first release tag
7. âœ… Test formula installation